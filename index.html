<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Markpad</title>
	<script>
      (function(){
        var redirect = sessionStorage.redirect;
        delete sessionStorage.redirect;
        if (redirect && redirect != location.href) {
          history.replaceState(null, null, redirect);
        }
      })();
	</script>
	<meta name="fragment" content="!">
    <base href="/">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
	<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
	<script src="https://rawgit.com/eligrey/FileSaver.js/master/FileSaver.min.js"></script>
    <script type="text/javascript">
        let simpleMDE;

        const hash = window.location.hash.toString().replace("#!", "");

        const JSONToParams = function params(obj){
            return Object.keys(obj).map((k) => encodeURIComponent(k) + '=' + encodeURIComponent(obj[k])).join('&')
        };

        const updateDontpad = () => {
            fetch(`http://dontpad.com${hash}` , {
                body: JSONToParams({"text":simpleMDE.value()}),
                mode: "no-cors",
                headers: new Headers({
                    "Accept": "application/json",
                    "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
                }),
                method: "POST"
            }).then(function(res){
                console.log(res);
            });
        };

        var timeout = setTimeout( () => {
			simpleMDE = new SimpleMDE({
				element: document.querySelector("[data-selector='markpad-textarea']"),
			  	autofocus: true,
			 	toolbar: [
					"bold", "italic", "heading", "|" , "quote", "unordered-list", "ordered-list", "|",
					"link", "image", "|", "preview", "side-by-side", "|", "guide", {
						"name": "save",
						"action": () => {
                    		var file = new File([simpleMDE.value()], `${hash}.txt`, {type: "text/plain;charset=utf-8"});
        					saveAs(file);
						},
						"className": "fa fa-hdd-o",
						"title": "Save file"
					}
				]
			});
			simpleMDE.toggleFullScreen();
        }, 0);

        var intervalShowMDEContent = setInterval( () => {
            updateDontpad();
        }, 2000);

    </script>
</head>
<body data-selector="markpad">
	<textarea data-selector="markpad-textarea"></textarea>
</body>
</html>